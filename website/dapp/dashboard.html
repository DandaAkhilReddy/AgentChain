<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentChains Dashboard - KAMIKAZE Token Transactions</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://unpkg.com/web3@latest/dist/web3.min.js"></script>
    <script src="../js/blockchain.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .dapp-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            padding: 2rem 1rem;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 2rem;
            color: #00d4ff;
        }

        .nav-item {
            display: block;
            padding: 1rem;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(0, 212, 255, 0.2);
            border-left: 4px solid #00d4ff;
        }

        .main-content {
            padding: 2rem;
            overflow-y: auto;
        }

        .wallet-section {
            background: rgba(0, 0, 0, 0.2);
            padding: 2rem;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 2rem;
        }

        .wallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .wallet-address {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .address-text {
            font-family: monospace;
            font-size: 1.1rem;
        }

        .copy-btn {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: rgba(0, 212, 255, 0.3);
        }

        .balance-display {
            text-align: center;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .balance-label {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        .balance-amount {
            font-size: 3rem;
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 0.5rem;
        }

        .balance-usd {
            font-size: 1.2rem;
            opacity: 0.7;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .btn {
            background: linear-gradient(135deg, #00d4ff, #ff6b35);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.3);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #00d4ff;
        }

        .transaction-section {
            background: rgba(0, 0, 0, 0.2);
            padding: 2rem;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 2rem;
        }

        .transaction-form {
            display: grid;
            gap: 1.5rem;
        }

        .form-group {
            display: grid;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 500;
            opacity: 0.9;
        }

        .form-input {
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #00d4ff;
            background: rgba(0, 0, 0, 0.4);
        }

        .amount-helpers {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .helper-btn {
            padding: 0.5rem 1rem;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 6px;
            color: #00d4ff;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .helper-btn:hover {
            background: rgba(0, 212, 255, 0.2);
            border-color: #00d4ff;
        }

        .fee-info {
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid rgba(255, 107, 53, 0.3);
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .transaction-history {
            background: rgba(0, 0, 0, 0.2);
            padding: 2rem;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .transaction-list {
            display: grid;
            gap: 1rem;
        }

        .transaction-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1rem;
            align-items: center;
            transition: all 0.3s ease;
        }

        .transaction-item:hover {
            background: rgba(0, 0, 0, 0.3);
            border-color: rgba(0, 212, 255, 0.3);
        }

        .tx-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .tx-icon.sent {
            background: rgba(255, 107, 53, 0.2);
        }

        .tx-icon.received {
            background: rgba(0, 255, 136, 0.2);
        }

        .tx-details {
            display: grid;
            gap: 0.3rem;
        }

        .tx-type {
            font-weight: 500;
            font-size: 1.1rem;
        }

        .tx-address {
            font-family: monospace;
            font-size: 0.9rem;
            opacity: 0.7;
        }

        .tx-time {
            font-size: 0.8rem;
            opacity: 0.6;
        }

        .tx-amount {
            text-align: right;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .tx-amount.sent {
            color: #ff6b35;
        }

        .tx-amount.received {
            color: #00ff88;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            opacity: 0.6;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-connected {
            background: #00ff88;
            animation: pulse 2s infinite;
        }

        .status-disconnected {
            background: #ff4444;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00d4ff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .dapp-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dapp-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <span>🔗</span>
                <span>AgentChains</span>
            </div>
            
            <div class="nav-item active" onclick="showSection('dashboard')">
                <span>📊</span> Dashboard
            </div>
            
            <div class="nav-item" onclick="showSection('send')">
                <span>💸</span> Send
            </div>
            
            <div class="nav-item" onclick="showSection('history')">
                <span>📜</span> History
            </div>
            
            <a href="../staking.html" class="nav-item">
                <span>🔒</span> Staking
            </a>
            
            <a href="../agent-creator.html" class="nav-item">
                <span>🤖</span> AI Agents
            </a>
            
            <div class="nav-item" onclick="logout()">
                <span>🚪</span> Logout
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section">
                <h1>AgentChains Dashboard</h1>
                
                <!-- Wallet Info -->
                <div class="wallet-section">
                    <div class="wallet-header">
                        <h2>My Wallet</h2>
                        <div id="connectionStatus">
                            <span class="status-indicator status-disconnected"></span>
                            <span>Not Connected</span>
                        </div>
                    </div>
                    
                    <div class="wallet-address" id="walletAddressSection" style="display: none;">
                        <span class="address-text" id="walletAddress">0x0000...0000</span>
                        <button class="copy-btn" onclick="copyAddress()">📋 Copy</button>
                    </div>
                    
                    <div class="balance-display">
                        <div class="balance-label">Total Balance</div>
                        <div class="balance-amount" id="kamikazeBalance">0</div>
                        <div class="balance-usd">≈ $0.00 USD</div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn" onclick="showSection('send')">Send</button>
                        <button class="btn btn-outline" onclick="showReceiveModal()">Receive</button>
                        <button class="btn btn-outline" onclick="window.location.href='../staking.html'">Stake</button>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="transaction-history">
                    <div class="history-header">
                        <h2>Recent Activity</h2>
                        <button class="btn btn-outline" onclick="showSection('history')">View All</button>
                    </div>
                    <div id="recentActivity" class="transaction-list">
                        <div class="empty-state">No recent transactions</div>
                    </div>
                </div>
            </div>
            
            <!-- Send Section -->
            <div id="send-section" class="section" style="display: none;">
                <h1>Send KAMIKAZE Tokens</h1>
                
                <div class="transaction-section">
                    <form class="transaction-form" onsubmit="sendTokens(event)">
                        <div class="form-group">
                            <label class="form-label">Recipient Address</label>
                            <input type="text" 
                                   class="form-input" 
                                   id="recipientAddress" 
                                   placeholder="0x..." 
                                   pattern="^0x[a-fA-F0-9]{40}$"
                                   required>
                            <small style="opacity: 0.7;">Enter a valid Ethereum address</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Amount (KAMIKAZE)</label>
                            <input type="number" 
                                   class="form-input" 
                                   id="sendAmount" 
                                   placeholder="0.00" 
                                   min="1" 
                                   step="any"
                                   required>
                            <div class="amount-helpers">
                                <button type="button" class="helper-btn" onclick="setAmount(25)">25%</button>
                                <button type="button" class="helper-btn" onclick="setAmount(50)">50%</button>
                                <button type="button" class="helper-btn" onclick="setAmount(75)">75%</button>
                                <button type="button" class="helper-btn" onclick="setAmount(100)">MAX</button>
                            </div>
                        </div>
                        
                        <div class="fee-info">
                            ⚠️ 2% burn fee will be applied to all transfers
                            <div id="feeCalculation" style="margin-top: 0.5rem;"></div>
                        </div>
                        
                        <button type="submit" class="btn" id="sendBtn">
                            Send KAMIKAZE
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- History Section -->
            <div id="history-section" class="section" style="display: none;">
                <h1>Transaction History</h1>
                
                <div class="transaction-history">
                    <div id="fullHistory" class="transaction-list">
                        <div class="empty-state">Loading transactions...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Global variables
        let blockchain = window.agentBlockchain;
        let userAccount = null;
        let connected = false;
        let web3 = null;

        // Initialize on load
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('KAMIKAZE Dashboard loaded');
            
            // Check MetaMask
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                await checkConnection();
            } else {
                setTimeout(() => {
                    if (confirm('MetaMask not detected. Would you like to install it?')) {
                        window.open('https://metamask.io/download/', '_blank');
                    }
                }, 1000);
            }
            
            // Listen for blockchain events
            blockchain.on('transactionCreated', updateUI);
            blockchain.on('blockMined', updateUI);
            
            // Update balance periodically
            setInterval(updateBalance, 5000);
        });

        // Check existing connection
        async function checkConnection() {
            try {
                const accounts = await web3.eth.getAccounts();
                if (accounts.length > 0) {
                    await connectWallet(accounts[0]);
                } else {
                    // Auto-connect prompt
                    setTimeout(promptConnection, 2000);
                }
            } catch (error) {
                console.error('Connection check failed:', error);
            }
        }

        // Prompt for connection
        async function promptConnection() {
            if (!connected) {
                const shouldConnect = confirm('Connect your wallet to start using KAMIKAZE tokens?');
                if (shouldConnect) {
                    await connectWallet();
                }
            }
        }

        // Connect wallet
        async function connectWallet(existingAccount = null) {
            try {
                let account = existingAccount;
                
                if (!account) {
                    const accounts = await window.ethereum.request({
                        method: 'eth_requestAccounts'
                    });
                    account = accounts[0];
                }
                
                userAccount = account;
                connected = true;
                
                // Create blockchain account
                blockchain.createAccount(userAccount);
                
                // Update UI
                updateUI();
                
                // Listen for account changes
                window.ethereum.on('accountsChanged', handleAccountChange);
                window.ethereum.on('chainChanged', () => window.location.reload());
                
                console.log('Connected to wallet:', userAccount);
            } catch (error) {
                console.error('Failed to connect:', error);
                alert('Failed to connect wallet. Please try again.');
            }
        }

        // Handle account change
        function handleAccountChange(accounts) {
            if (accounts.length === 0) {
                logout();
            } else if (accounts[0] !== userAccount) {
                connectWallet(accounts[0]);
            }
        }

        // Update UI
        function updateUI() {
            updateConnectionStatus();
            updateBalance();
            updateTransactionHistory();
        }

        // Update connection status
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            const addressSection = document.getElementById('walletAddressSection');
            const addressElement = document.getElementById('walletAddress');
            
            if (connected && userAccount) {
                statusElement.innerHTML = `
                    <span class="status-indicator status-connected"></span>
                    <span>Connected</span>
                `;
                
                addressSection.style.display = 'flex';
                addressElement.textContent = userAccount;
            } else {
                statusElement.innerHTML = `
                    <span class="status-indicator status-disconnected"></span>
                    <span>Not Connected</span>
                    <button class="btn" onclick="connectWallet()">Connect</button>
                `;
                
                addressSection.style.display = 'none';
            }
        }

        // Update balance
        function updateBalance() {
            if (connected && userAccount) {
                const balance = blockchain.getBalance(userAccount);
                document.getElementById('kamikazeBalance').textContent = balance.toLocaleString();
                
                // Update USD value (mock price)
                const usdValue = balance * 0.00001; // Mock price
                document.querySelector('.balance-usd').textContent = `≈ $${usdValue.toFixed(2)} USD`;
            }
        }

        // Update transaction history
        function updateTransactionHistory() {
            if (!connected || !userAccount) return;
            
            const transactions = blockchain.getTransactionHistory(userAccount);
            const recentActivity = document.getElementById('recentActivity');
            const fullHistory = document.getElementById('fullHistory');
            
            if (transactions.length === 0) {
                recentActivity.innerHTML = '<div class="empty-state">No recent transactions</div>';
                fullHistory.innerHTML = '<div class="empty-state">No transactions yet</div>';
                return;
            }
            
            // Recent activity (last 3)
            const recentTxs = transactions.slice(0, 3);
            recentActivity.innerHTML = recentTxs.map(tx => createTransactionElement(tx)).join('');
            
            // Full history
            fullHistory.innerHTML = transactions.map(tx => createTransactionElement(tx)).join('');
        }

        // Create transaction element
        function createTransactionElement(tx) {
            const isSent = tx.fromAddress === userAccount;
            const type = isSent ? 'sent' : 'received';
            const address = isSent ? tx.toAddress : tx.fromAddress;
            const amount = isSent ? `-${tx.amount}` : `+${tx.netAmount || tx.amount}`;
            const time = new Date(tx.timestamp).toLocaleString();
            
            return `
                <div class="transaction-item">
                    <div class="tx-icon ${type}">
                        ${isSent ? '↗️' : '↘️'}
                    </div>
                    <div class="tx-details">
                        <div class="tx-type">${isSent ? 'Sent' : 'Received'}</div>
                        <div class="tx-address">${formatAddress(address)}</div>
                        <div class="tx-time">${time}</div>
                    </div>
                    <div class="tx-amount ${type}">${amount} KAMIKAZE</div>
                </div>
            `;
        }

        // Format address
        function formatAddress(address) {
            if (!address) return 'Unknown';
            if (address === 'system') return 'System';
            if (address === 'staking_pool') return 'Staking Pool';
            return `${address.slice(0, 6)}...${address.slice(-4)}`;
        }

        // Copy address
        function copyAddress() {
            if (userAccount) {
                navigator.clipboard.writeText(userAccount);
                alert('Address copied to clipboard!');
            }
        }

        // Send tokens
        async function sendTokens(event) {
            event.preventDefault();
            
            if (!connected) {
                alert('Please connect your wallet first');
                return;
            }
            
            const recipient = document.getElementById('recipientAddress').value;
            const amount = parseFloat(document.getElementById('sendAmount').value);
            
            // Validate
            if (!recipient || !web3.utils.isAddress(recipient)) {
                alert('Please enter a valid recipient address');
                return;
            }
            
            if (amount <= 0 || isNaN(amount)) {
                alert('Please enter a valid amount');
                return;
            }
            
            const balance = blockchain.getBalance(userAccount);
            if (amount > balance) {
                alert('Insufficient balance');
                return;
            }
            
            // Confirm transaction
            const burnAmount = amount * 0.02;
            const netAmount = amount - burnAmount;
            const confirm = window.confirm(
                `Send ${amount} KAMIKAZE to ${formatAddress(recipient)}?\n\n` +
                `Amount: ${amount} KAMIKAZE\n` +
                `Burn Fee (2%): ${burnAmount.toFixed(2)} KAMIKAZE\n` +
                `Recipient receives: ${netAmount.toFixed(2)} KAMIKAZE`
            );
            
            if (!confirm) return;
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading"></span> Sending...';
            
            try {
                // Create transaction
                const tx = new Transaction(userAccount, recipient, amount);
                blockchain.createTransaction(tx);
                
                // Mine the transaction
                await blockchain.minePendingTransactions(userAccount);
                
                alert(`Successfully sent ${amount} KAMIKAZE!\nTransaction ID: ${tx.id}`);
                
                // Reset form
                document.getElementById('recipientAddress').value = '';
                document.getElementById('sendAmount').value = '';
                
                // Go back to dashboard
                showSection('dashboard');
            } catch (error) {
                console.error('Transaction failed:', error);
                alert('Transaction failed: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'Send KAMIKAZE';
            }
        }

        // Set amount helpers
        function setAmount(percentage) {
            const balance = blockchain.getBalance(userAccount);
            const amount = (balance * percentage) / 100;
            document.getElementById('sendAmount').value = Math.floor(amount);
            updateFeeCalculation();
        }

        // Update fee calculation
        function updateFeeCalculation() {
            const amount = parseFloat(document.getElementById('sendAmount').value) || 0;
            const burnAmount = amount * 0.02;
            const netAmount = amount - burnAmount;
            
            const feeCalc = document.getElementById('feeCalculation');
            if (amount > 0) {
                feeCalc.innerHTML = `
                    Burn: ${burnAmount.toFixed(2)} KAMIKAZE<br>
                    Recipient receives: ${netAmount.toFixed(2)} KAMIKAZE
                `;
            } else {
                feeCalc.innerHTML = '';
            }
        }

        // Show receive modal
        function showReceiveModal() {
            if (!connected) {
                alert('Please connect your wallet first');
                return;
            }
            
            alert(`Your KAMIKAZE address:\n${userAccount}\n\nShare this address to receive tokens.`);
        }

        // Show section
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            
            // Show selected section
            const sectionElement = document.getElementById(`${section}-section`);
            if (sectionElement) {
                sectionElement.style.display = 'block';
            }
            
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Logout
        function logout() {
            connected = false;
            userAccount = null;
            window.location.href = '../index.html';
        }

        // Listen for amount input
        document.getElementById('sendAmount')?.addEventListener('input', updateFeeCalculation);
    </script>
</body>
</html>